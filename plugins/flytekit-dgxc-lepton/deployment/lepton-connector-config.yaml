apiVersion: v1
kind: ConfigMap
metadata:
  name: flyte-sandbox-config
  namespace: flyte
data:
  001-plugins.yaml: |
    tasks:
      task-plugins:
        default-for-task-types:
          container: container
          container_array: k8s-array
          sidecar: sidecar
          lepton_endpoint_deployment_task: connector-service  # Route deployment tasks to connector service
          lepton_endpoint_deletion_task: connector-service     # Route deletion tasks to connector service
        enabled-plugins:
        - container
        - sidecar
        - k8s-array
        - connector-service
        - echo
    plugins:
      logs:
        kubernetes-enabled: true
        kubernetes-template-uri: http://localhost:30080/kubernetes-dashboard/#/log/{{.namespace }}/{{ .podName }}/pod?namespace={{ .namespace }}
        cloudwatch-enabled: false
        stackdriver-enabled: false
      k8s:
        co-pilot:
          image: "cr.flyte.org/flyteorg/flytecopilot:v1.16.0"
      k8s-array:
        logs:
          config:
            kubernetes-enabled: true
            kubernetes-template-uri: http://localhost:30080/kubernetes-dashboard/#/log/{{.namespace }}/{{ .podName }}/pod?namespace={{ .namespace }}
            cloudwatch-enabled: false
            stackdriver-enabled: false
      connector-service:
        defaultConnector:
          defaultTimeout: 10s
          endpoint: k8s://flyteconnector.flyte:8000
          insecure: true
          timeouts:
            GetTask: 10s
            ListAgents: 3s
        connectors:
          # Route lepton deployment tasks to our dedicated connector with extended timeouts
          lepton_endpoint_deployment_task:
            endpoint: k8s://lepton-connector-service.flyte:8000
            insecure: true
            defaultTimeout: 600s  # 10 minutes default
            timeouts:
              GetTask: 300s      # 5 minutes for status checks
              CreateTask: 10800s # 3 hours for large model deployment (Nemotron Super)
              DeleteTask: 300s   # 5 minutes for deletion
          # Route lepton deletion tasks to the same connector with appropriate timeouts
          lepton_endpoint_deletion_task:
            endpoint: k8s://lepton-connector-service.flyte:8000
            insecure: true
            defaultTimeout: 300s  # 5 minutes default for deletion
            timeouts:
              GetTask: 60s       # 1 minute for status checks
              CreateTask: 300s   # 5 minutes for deletion operations
              DeleteTask: 300s   # 5 minutes for cleanup
