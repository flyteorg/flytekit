FROM python:3.10-slim-bookworm AS connector-slim

LABEL org.opencontainers.image.authors="Flyte Team <users@flyte.org>"
LABEL org.opencontainers.image.source=https://github.com/flyteorg/flytekit

ARG VERSION

RUN apt-get update && apt-get install build-essential -y \
    && pip install uv
# Pin pendulum<3.0: Apache Airflow (via flytekitplugins-airflow) imports
# pendulum.tz.timezone() at module load time (airflow/settings.py).
# Pendulum 3.x changed the tz API, causing the connector to crash on startup:
#   airflow/settings.py → TIMEZONE = pendulum.tz.timezone("UTC") → AttributeError
# Without this pin, uv resolves to pendulum 3.x which breaks the import chain:
#   pyflyte serve connector → load_implicit_plugins → airflow → pendulum → crash
RUN uv pip install --system --no-cache-dir -U \
  "pendulum>=2.0.0,<3.0" \
  flytekit[connector]==$VERSION \
  flytekitplugins-airflow==$VERSION \
  flytekitplugins-bigquery==$VERSION \
  flytekitplugins-k8sdataservice==$VERSION \
  flytekitplugins-openai==$VERSION \
  flytekitplugins-slurm==$VERSION \
  flytekitplugins-snowflake==$VERSION \
  flytekitplugins-awssagemaker==$VERSION \
  && apt-get clean autoclean \
  && apt-get autoremove --yes \
  && rm -rf /var/lib/{apt,dpkg,cache,log}/ \
  && :

CMD ["pyflyte", "serve", "connector", "--port", "8000"]

FROM connector-slim AS connector-all
ARG VERSION

RUN uv pip install --system --no-cache-dir -U \
  flytekitplugins-mmcloud==$VERSION \
  flytekitplugins-spark==$VERSION